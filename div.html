<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1pulse Online Map</title>
    <link rel="icon" href="https://1pulse.online/images/ipulse-logo.png" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="all-styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <script>
        // Disable right-click on the page
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
    </script>

    <div id="map"></div>

    <!-- Dark Mode Toggle Button -->
    <button id="modal-button" onclick="openModal('gjnoModal')">
        <img src="https://i.ibb.co/Q35sd45k/1pulse-online-logo-CRc-L2.png" alt="1Pulse" style="width: 53px; height: 50px; vertical-align: middle;">
    </button>

    <!-- Modal for Greater Johannesburg Neighborhood Oversight -->
    <div id="gjnoModal" class="gjno-modal">
        <div class="gjno-modal-content">
            <span class="gjno-close" onclick="closeModal('gjnoModal')" style="color: #2b2b2b; margin: 0px! Important;">&times;</span>
            <div class="cotainer">
                <!-- Section 1: Header, Search Bar, Hero Image -->
                <div class="section-1">
                    <header>
                        <div class="side-logo">
                            <img src="https://i.ibb.co/S4jWXkFv/1pulse-online-logo-CRc-L3.png" alt="Logo">
                            <span></span>
                        </div>
                        <button id="guest-button" onclick="window.location.href='https://1pulse.online/dashboard/three.html'" style="border-radius:22px; margin-right:10px;">Guest</button>
                    </header>
                    <header>
                        <h1>Community Resources Map</h1>
                    </header>
                    <div class="hero-image">
                        <img src="https://1pulse.online/images/1pulse-promo-map.png" alt="Community map image" />
                    </div>
                    <div class="image-description">
                        <p>This map highlights key community issues and available resources. Explore the markers to find out more.</p>
                    </div>
                    <button id="install-button" style="display: none;">Install App</button>
                </div>

                <!-- Section 2: Resources Description -->
                <div class="section-2">
                    <h2>First Responders</h2>
                    <p>This indicator helps us see who solved what problem. This is good for businesses and government departments dedicated to helping the community.</p>
                    <h2>Resources</h2>
                    <p>Explore the various resources available within the community, designed to assist you in solving problems and improving quality of life.</p>
                </div>

                <!-- Section 3: Markers and Sponsors -->
                <div class="section-3">
                    <div class="markers">
                        <div class="marker-item">
                            <img src="https://1pulse.online/images/user-here.png" alt="Marker Icon 1" />
                            <div class="marker-info">
                                <h4>You Are Here</h4>
                                <p>Click the closest next to this icon and a window will show up so you can make a post.</p>
                            </div>
                        </div>
                        <!-- Add other marker items here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logo Navigation -->
    <div id="logo-nav">
        <div id="logo-container">
            <div class="logo" data-modal-id="1">
                <img src="https://1pulse.online/images/errand%20camel%20logo.png" alt="Logo 1">
            </div>
            <!-- Add other logos here -->
        </div>
    </div>

    <!-- Modal for logos -->
    <div id="myModal" class="modal-brah">
        <div class="modal-content-brah">
            <span class="close-brah" onclick="closeModal('myModal')">&times;</span>
            <h2 class="modal-title-brah"></h2>
            <p class="modal-description-brah"></p>
            <div class="image-container">
                <img class="modal-image-brah" src="" alt="Modal Image">
            </div>
        </div>
    </div>

    <!-- New Post Modal -->
    <div id="newPostModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newPostModal')">&times;</span>
            <h3 id="newPostTitle">What's happening?</h3>
            <div class="location-banner" id="locationBanner"></div>
            <form id="newPostForm">
                <input type="text" id="newPostName" placeholder="Name" required><br>
                <input type="text" id="newPostSurname" placeholder="Surname" required><br>
                <textarea id="newPostDescription" placeholder="Describe your post" required></textarea><br>
                <button type="submit" class="btn">Post</button>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').then(() => {
                console.log('Service Worker registered');
            });
        }

        // Install Prompt Handling
        let deferredPrompt;
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Typing Effect
        const typingText = document.getElementById('typingText');
        const text = 'The heartbeat of the community.';
        let index = 0;

        function typeWriter() {
            if (index < text.length) {
                typingText.textContent += text.charAt(index);
                index++;
                setTimeout(typeWriter, 150);
            } else {
                setTimeout(() => {
                    typingText.textContent = '';
                    index = 0;
                    typeWriter();
                }, 2000);
            }
        }

        typeWriter();

        // Geolocation and New Post Modal
        let currentLocation = {
            latitude: null,
            longitude: null,
            street: null,
            town: null,
            ward: null
        };

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentLocation.latitude = position.coords.latitude;
                    currentLocation.longitude = position.coords.longitude;
                    fetchStreetData();
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        async function fetchStreetData() {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLocation.latitude}&lon=${currentLocation.longitude}&format=json`);
                const data = await response.json();
                currentLocation.street = data.address.road || 'Unknown Street';
                currentLocation.town = data.address.town || 'Unknown Town';
                currentLocation.ward = data.address.ward || 'Unknown Ward';

                document.getElementById('locationBanner').textContent = `You are in ${currentLocation.street}, ${currentLocation.town}. Ward: ${currentLocation.ward}`;
            } catch (error) {
                console.error('Error fetching street data:', error);
            }
        }

        document.getElementById('newPostForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const name = document.getElementById('newPostName').value;
            const surname = document.getElementById('newPostSurname').value;
            const description = document.getElementById('newPostDescription').value;

            const postData = {
                name,
                surname,
                description,
                location: currentLocation
            };

            console.log('New Post:', postData);
            closeModal('newPostModal');
            document.getElementById('newPostForm').reset();
        });

        getUserLocation();
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Custom JS -->
    <script src="logic.js"></script>
</body>
</html>